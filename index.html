<!DOCTYPE html>
<html>
  <head>
    <title>HW 1 Natasha Aysseh nca28</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>

    <style>
      .domain {
        visibility: hidden;
      }

      .main-div {
        /* margin-left: 100px */
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .big-div {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
      }

      .title-block {
        height: 100px;
        margin-left: 20px;
        margin-right: 20px;
        background-color: #82CD47;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      #title {
        font-size: 30px;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold;
        color: darkslategray;
      }

      .sub-title-block p {
        font-size: 20px;
        margin-left: 40px;
        margin-right: 40px;;
        font-family: Arial, Helvetica, sans-serif;
        color: darkslategray;
        text-align: center;
      }

      .sub-title-block {
        height: 50px;
        margin-left: 20px;
        margin-right: 20px;
        margin-top: 30px;
        /* background-color: #82CD47; */
        display: flex;
        /* flex-direction: column; */
        justify-content: center;
        align-items: center;
      }
      
    </style>
    
  </head>
<body>

  <div class="title-block">
    <p id="title">San Francisco's Trees: Who are the caretakers?</p>
  </div>
  <div class="sub-title-block">
    <p>How can we break down the ownership of SF's trees into public and private ownership? What is the balance between the two, and where are the trees most concentrated?</p>
  </div>
  </div>
  <div class="big-div">
    <div id="graph1">
      <svg id="sfMap" width="400" height="400"></svg>
    </div>
    <div class="main-div">
      <svg id="bar" width="400" height="200"></svg>
      <svg id="lollipop" width="700" height="500"></svg>
    </div>
  </div>
  
  <script>


    const barChart = d3.select("svg#bar");
    const widthBar = barChart.attr("width");
    const heightBar = barChart.attr("height");
    const marginsBar = {top: 10, right: 10, bottom: 50, left: 50};

    const svg = d3.select("svg#sfMap");
    const widthMap = svg.attr("width");
    const heightMap = svg.attr("height");
    const marginsMap = {top: 10, right: 10, bottom: 10, left: 10};

    const lolli = d3.select("svg#lollipop");
    const widthLolli = lolli.attr("width");
    const heightLolli = lolli.attr("height");
    const marginsLolli = {top: 10, right: 10, bottom: 50, left: 150};

    const lolliWidth = widthLolli - marginsLolli.left - marginsLolli.right;
    const lolliHeight = heightLolli - marginsLolli.top - marginsLolli.bottom;

    const mapWidth = widthMap - marginsMap.left - marginsMap.right;
    const mapHeight = heightMap - marginsMap.top - marginsMap.bottom;

    const barWidth = widthBar - marginsBar.left - marginsBar.right;
    const barHeight = heightBar - marginsBar.top - marginsBar.bottom;

    const barChartArea = barChart.append("g")
                                 .attr("transform", `translate(${marginsBar.left}, ${marginsBar.top})`);

    const mapArea = svg.append("g")
                       .attr("transform",`translate(${marginsMap.left}, ${marginsMap.top})`);
    
    const lolliArea = lolli.append("g")
                           .attr("transform", `translate(${marginsLolli.left}, ${marginsLolli.top})`);
                             
    const requestData = async function () { 
      const data = await d3.csv("SF_trees.csv", d3.autoType);

      const topoData = await d3.json("SF-Neighborhoods.geo.json");
      console.log(data); //data log
      console.log(topoData);

      // create list of counts for each type of ownership (City v private) and for the types of sites (on/near sidewalk vs in a yard) - this is for the bar chart
      let ownerships = d3.rollup(data, v => v.length, d => d.ownerClean);
      let sites = d3.rollup(data, v => v.length, d => d.siteClean);
      console.log(ownerships);

      let ownerships2 = d3.rollups(data, v => v.length, d => d.qCaretaker);
      console.log(ownerships2);


      ownerships2.sort((a, b) => d3.descending(a[1], b[1]));
      console.log(ownerships2);

      //sorted list of owners
      let ownerMap = ownerships2.flat().filter(d => isNaN(d));
      // array1.flat().map(arr => arr[0])
      console.log(ownerMap);

      let ownershipExtent = d3.extent(ownerships2, d => d[1]);
      console.log(ownershipExtent);

      // let ownershipTypes = ['Private', 'City'];
      // let siteTypes = ['Sidewalk', 'Yard'];

      let ownershipArray = {category: "Owner", private: ownerships.get("Private"), city: ownerships.get("City")};
      let siteArray = {category: "Site", sidewalk: sites.get("Sidewalk"), yard: sites.get("Yard")};

      console.log(ownershipArray, siteArray);

      var mesh = topojson.mesh(topoData, topoData.objects.SFNeighborhoods);
      var features = topojson.feature(topoData, topoData.objects.SFNeighborhoods);

      // create priojection/path
      var proj = d3.geoMercator().fitSize([mapWidth, mapHeight], features);
      var path = d3.geoPath().projection(proj);
  
      let viewport = mapArea.append("g");

      // *******START MAP CODE**********
      viewport.selectAll("path")
              .data(features.features)
              .join("path")
              .style("fill", "white") //this will need to be changed depending on what i'm doing 
              .attr("d", path);
      let meshPaths = viewport.append("path")  
                              .datum(mesh)
                              .style("stroke-width", "1px")
                              .style("stroke", "gray")
                              .style("fill", "none")
                              .attr("d", path); 

      // fill in tree dots              
      let treeDots = viewport.selectAll("circle.tree")
                         .data(data)
                         .join("circle")  
                         .attr("class", "tree")
                         .attr("cx", d => proj([d.Longitude, d.Latitude])[0])  
                         .attr("cy", d => proj([d.Longitude, d.Latitude])[1])     
                         .attr("r", "1px")       
                         .style("fill", "green")
      //add in circle to show most populated areas
      viewport.append("circle") 
              .attr("cx", proj([-122.495070, 37.749028])[0])
              .attr("cy", proj([-122.495070, 37.749028])[1])
              .attr("r", 50)
              .style("fill", "none")
              .style("stroke", "black")
              .style("stroke-width", "3px")     
              
      viewport.append("circle") 
              .attr("cx", proj([-122.427811, 37.774754])[0])
              .attr("cy", proj([-122.427811, 37.774754])[1])
              .attr("r", 70)
              .style("fill", "none")
              .style("stroke", "black")
              .style("stroke-width", "3px") 

      //  ****END MAP CODE*******
                        
      // *******START BAR CHART CODE**********

      // x scale for stacked chart
      // const xScaleBand = d3.scaleBand()
      //                      .domain(['Owner', 'Site'])
      //                      .rangeRound([marginsBar.left, barWidth]);  

      // // y scale for left axis
      // const yScaleOwner = d3.scaleLinear()
      //                       .domain([0, (ownershipArray.private +ownershipArray.city)])
      //                       .range([barHeight, 0]);
      
      // let xAxis = d3.axisBottom(xScaleBand);
      // barChartArea.append('g')
      //             .attr('class', 'x-axis')
      //             .attr('transform', `translate(${marginsBar.left - xScaleBand.bandwidth() / 2},${barHeight + marginsBar.top})`)
      //             .call(xAxis); 
      
      // // add label for bottom axis
      // barChartArea.append("text")
      //             .text("Type of Ownership")
      //             .attr('transform', `translate(${barWidth / 2  - marginsBar.left -20},${barHeight+marginsBar.bottom-5})`);

      // let yAxis = d3.axisLeft(yScaleOwner);
      // barChartArea.append('g')
      //             .attr('class', 'y-axis')
      //             .attr('transform', `translate(${0},${0})`)
      //             .call(yAxis);
      
      // writing elements manually bc i am getting confused with the join :( ... but it works! 
      // VERTICAL!!!!!!!
      // barChartArea.append("line")
      //             .attr("class", "barOwner")
      //             .attr("x1", xScaleBand("Owner") + xScaleBand.bandwidth()/4)
      //             .attr("x2", xScaleBand("Owner") + xScaleBand.bandwidth()/4)
      //             .attr("y1", barHeight)
      //             .attr("y2", yScaleOwner(ownershipArray.private))
      //             .style("stroke-width", xScaleBand.bandwidth()/2)
      //             .style("stroke", "pink");
      // barChartArea.append("line")
      //             .attr("class", "barOwner")
      //             .attr("x1", xScaleBand("Owner") + xScaleBand.bandwidth()/4)
      //             .attr("x2", xScaleBand("Owner") + xScaleBand.bandwidth()/4)
      //             .attr("y1", yScaleOwner(ownershipArray.private) - (barHeight - yScaleOwner(ownershipArray.city)) )
      //             .attr("y2", yScaleOwner(ownershipArray.private))
      //             .style("stroke-width", xScaleBand.bandwidth()/2)
      //             .style("stroke", "black");
      
      // barChartArea.append("line")
      //             .attr("class", "barSite")
      //             .attr("x1", xScaleBand("Site") + xScaleBand.bandwidth()/4)
      //             .attr("x2",  xScaleBand("Site") + xScaleBand.bandwidth()/4)
      //             .attr("y1", barHeight)
      //             .attr("y2", yScaleOwner(siteArray.sidewalk))
      //             .style("stroke-width", xScaleBand.bandwidth()/2)
      //             .style("stroke", "pink");
      // barChartArea.append("line")
      //             .attr("class", "barSite")
      //             .attr("x1", xScaleBand("Site") + xScaleBand.bandwidth()/4)
      //             .attr("x2",  xScaleBand("Site") + xScaleBand.bandwidth()/4)
      //             .attr("y1", yScaleOwner(siteArray.sidewalk) - (barHeight - yScaleOwner(siteArray.yard)) )
      //             .attr("y2", yScaleOwner(siteArray.sidewalk))
      //             .style("stroke-width", xScaleBand.bandwidth()/2)
      //             .style("stroke", "blue");
      // VERTICAL!!!!!!!

      // horizontal bars
      // new scales for horiztonal work
      const scaleBand = d3.scaleBand()
                           .domain(['Owner', 'Site'])
                           .rangeRound([barHeight, 0]);  

      // // y scale for left axis
      const scaleOwner = d3.scaleLinear()
                            .domain([0, (ownershipArray.private +ownershipArray.city)])
                            .range([marginsBar.left, barWidth+marginsBar.right]);

      let leftAxis = d3.axisLeft(scaleBand);
      barChartArea.append('g')
                  .attr('class', 'y-axis domain')
                  .attr('transform', `translate(${0},${0})`)
                  .call(leftAxis); 
      
      // // add label for left axis
      // barChartArea.append("text")
      //             .text("Ownership")
      //             .attr('transform', `translate(${0},${barHeight/2}) rotate(-90)`);

      let bottomAxis = d3.axisBottom(scaleOwner);
      barChartArea.append('g')
                  .attr('class', 'x-axis domain')
                  .attr('transform', `translate(${marginsBar.left - scaleBand.bandwidth() / 2},${barHeight + marginsBar.top})`)
                  .call(bottomAxis);

      barChartArea.append("line")
                  .attr("class", "barOwner")
                  .attr("x1", 0)
                  .attr("x2", scaleOwner(ownershipArray.private))
                  .attr("y1", scaleBand("Owner") + scaleBand.bandwidth()/2)
                  .attr("y2", scaleBand("Owner") + scaleBand.bandwidth()/2)
                  .style("stroke-width", scaleBand.bandwidth()-20)
                  .style("stroke", "#3D5656");

      barChartArea.append("line")
                  .attr("class", "barOwner")
                  .attr("x1", scaleOwner(ownershipArray.private))
                  .attr("x2", scaleOwner(ownershipArray.private) + scaleOwner(ownershipArray.city))
                  .attr("y1", scaleBand("Owner") + scaleBand.bandwidth()/2 )
                  .attr("y2", scaleBand("Owner") + scaleBand.bandwidth()/2)
                  .style("stroke-width", scaleBand.bandwidth()-20)
                  .style("stroke", "#68B984");

      // barChartArea.append("line")
      //             .attr("class", "barSite")
      //             .attr("x1", 0)
      //             .attr("x2", scaleOwner(siteArray.sidewalk))
      //             .attr("y1", scaleBand("Site") + scaleBand.bandwidth()/2)
      //             .attr("y2", scaleBand("Site") + scaleBand.bandwidth()/2)
      //             .style("stroke-width", scaleBand.bandwidth()/2)
      //             .style("stroke", "#285430");

      // barChartArea.append("line")
      //             .attr("class", "barSite")
      //             .attr("x1", scaleOwner(siteArray.sidewalk))
      //             .attr("x2", scaleOwner(siteArray.sidewalk) + scaleOwner(siteArray.yard))
      //             .attr("y1", scaleBand("Site") + scaleBand.bandwidth()/2 )
      //             .attr("y2", scaleBand("Site") + scaleBand.bandwidth()/2)
      //             .style("stroke-width", scaleBand.bandwidth()/2)
      //             .style("stroke", "#A4BE7B");

      // horizontal bars

      // ********START LOLLIPOP CODE*********
      const lolliScale = d3.scaleLog()
                            .domain(ownershipExtent)
                            .range([0, lolliWidth]);

                            console.log(ownershipExtent, "brusdnjk")
      const ownerScale = d3.scalePoint()
                           .domain(ownerMap)
                           .range([0, lolliHeight])
      
      console.log('testing scale', lolliScale(700))         

      let bottomAxisLolli = d3.axisBottom(lolliScale).ticks(10);
      lolliArea.append('g')
                  .attr('class', 'x-axis')
                  .attr('transform', `translate(${0}, ${lolliHeight + marginsLolli.top})`)
                  .call(bottomAxisLolli);

      let leftAxisLolli = d3.axisLeft(ownerScale);           
      lolliArea.append('g')
                  .attr('class', 'y-axis')
                  .attr("transform", `translate(${0}, ${0})`)
                  .call(leftAxisLolli);

      //now join lollipop sticks fgfsnkdfngdkncdscbdhj 
      let sticks = lolliArea.selectAll("line.sticks")
               .data(ownerships2)
               .join("line")
               .attr("class", "sticks")
               .attr("id", d => d[1])
               .attr("x1", 0)
               .attr("x2", d => lolliScale(d[1]))
               .attr("y1", d => ownerScale(d[0]))
               .attr("y2", d => ownerScale(d[0]))
               .style("stroke-width", "2px")
               .style("stroke", "grey");

      lolliArea.selectAll("circle.lollipop")
            .data(ownerships2)
            .join("circle")
            .attr("class", "lollipop")
            .attr("cx", d => lolliScale(d[1]))
            .attr("cy", d => ownerScale(d[0]))
            .attr("r", 4)
            .style("fill", "#54B435")



      // ********END LOLLIPOP**********
    
    }

    requestData();
  </script>


</body>
</html>